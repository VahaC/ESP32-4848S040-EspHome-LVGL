esphome:
  name: esphome-esp32-s3-4848s040
  friendly_name: Esphome-ESP32-S3-4848S040
  on_boot:
    priority: 600
    then:
      - text.set:
          id: text_color_hex
          value: !lambda |-
            int r = id(text_color_r_glob);
            int g = id(text_color_g_glob);
            int b = id(text_color_b_glob);
            if (r < 0) r = 0; if (r > 255) r = 255;
            if (g < 0) g = 0; if (g > 255) g = 255;
            if (b < 0) b = 0; if (b > 255) b = 255;
            char buf[8];
            sprintf(buf, "%02X%02X%02X", r, g, b);
            return std::string(buf);

esp32:
  variant: esp32s3
  framework:
    type: esp-idf

# Enable logging
logger:
  baud_rate: 0
  level: INFO

# Enable web server
web_server:
  version: 3

# Enable Home Assistant API
api:
  encryption:
    key: "7KZ0v/YsESK1KxZffUyZawrYTG/7rB5q8bNKJHSKJmM="

ota:
  - platform: esphome
    password: "5a0418442eb57f47e0b5360ed4b49cc1"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case Wi-Fi connection fails
  ap:
    ssid: "Esphome-Esp32-S3-4848S040"
    password: "AWwK5mCFhfZC"

captive_portal:

debug:
  update_interval: 5s

text_sensor:
  - platform: debug
    device:
      name: "Device Info"
    reset_reason:
      name: "Reset Reason"

text:
  - platform: template
    name: "Text Color Hex"
    id: text_color_hex
    optimistic: true
    mode: text
    max_length: 7
    on_value:
      then:
        - lambda: |-
            // Parse HEX string like "#F0F0F0" or "F0F0F0" from Home Assistant UI
            std::string s = x;

            // Trim leading/trailing whitespace
            while (!s.empty() && (s.front() == ' ' || s.front() == '\n' || s.front() == '\r' || s.front() == '\t')) {
              s.erase(0, 1);
            }
            while (!s.empty() && (s.back() == ' ' || s.back() == '\n' || s.back() == '\r' || s.back() == '\t')) {
              s.pop_back();
            }

            // Optional leading '#'
            if (!s.empty() && s[0] == '#') {
              s = s.substr(1);
            }

            if (s.size() == 6) {
              unsigned int r, g, b;
              if (sscanf(s.c_str(), "%02x%02x%02x", &r, &g, &b) == 3) {
                id(text_color_r_glob) = (int) r;
                id(text_color_g_glob) = (int) g;
                id(text_color_b_glob) = (int) b;
                ESP_LOGI("text_color_hex", "Parsed HEX %s -> R=%u G=%u B=%u", s.c_str(), r, g, b);
                id(apply_text_color).execute();
                id(update_color_ui).execute();
              } else {
                ESP_LOGW("text_color_hex", "HEX parse failed for '%s'", s.c_str());
              }
            } else {
              ESP_LOGW("text_color_hex", "HEX must be 6 chars, got '%s'", s.c_str());
            }

# -------------------- GLOBALS (TEXT COLOR) --------------------
globals:
  # Global text color components (0..255), fully local on device
  - id: text_color_r_glob
    type: int
    restore_value: true
    initial_value: '255'

  - id: text_color_g_glob
    type: int
    restore_value: true
    initial_value: '255'

  - id: text_color_b_glob
    type: int
    restore_value: true
    initial_value: '255'

# -------------------- OUTPUTS --------------------
# Backlight PWM
output:
  - platform: ledc
    pin: GPIO38
    id: backlight_pwm
    frequency: 1000 Hz    # Lower PWM frequency for more stable backlight behavior

# -------------------- LIGHTS --------------------
light:
  # Backlight (internal), dimmable, state restored between reboots
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: back_light
    internal: false                # Expose to Home Assistant as a normal light
    default_transition_length: 1s
    restore_mode: RESTORE_DEFAULT_ON  # Restore last state; default ON if no saved state
    gamma_correct: 1.0                # Disable extra gamma correction; panel has its own curve

# -------------------- SPI / I2C / PSRAM --------------------
spi:
  clk_pin: GPIO48
  mosi_pin: GPIO47
  interface: hardware
  id: spihwd

i2c:
  id: touchscreen_bus
  sda: GPIO19
  scl:
    number: 45
    ignore_strapping_warning: true

psram:
  mode: octal
  speed: 80MHz

# -------------------- FONTS --------------------
font:
  - file: "gfonts://Montserrat"
    id: montserrat_120
    size: 120
    bpp: 4

  - file: "gfonts://Montserrat"
    id: montserrat_96
    size: 96
    bpp: 4

  - file: "gfonts://Montserrat"
    id: montserrat_45
    size: 45
    bpp: 4

  - file: "gfonts://Montserrat"
    id: montserrat_27
    size: 27
    bpp: 4

# -------------------- DISPLAY (ST7701S RGB) --------------------
display:
  - platform: st7701s
    id: tft_display
    spi_id: spihwd
    dimensions:
      width: 480
      height: 480
    # rotation: 270    # Uncomment for placement with down-facing USB socket
    spi_mode: MODE3
    data_rate: 2MHz
    color_order: RGB
    invert_colors: false
    cs_pin: 39
    de_pin: 18
    hsync_pin: 16
    vsync_pin: 17
    pclk_pin: 21
    pclk_frequency: 12MHz
    pclk_inverted: false
    hsync_pulse_width: 8
    hsync_front_porch: 10
    hsync_back_porch: 20
    vsync_pulse_width: 8
    vsync_front_porch: 10
    vsync_back_porch: 10
    auto_clear_enabled: false
    update_interval: never
    init_sequence:
      - 1
      - [0xFF, 0x77, 0x01, 0x00, 0x00, 0x10] # CMD2_BKSEL_BK0
      - [0xCD, 0x00] # Disable MDT flag
    data_pins:
      red: [11, 12, 13, 14, 0]
      green: [8, 20, 3, 46, 9, 10]
      blue: [4, 5, 6, 7, 15]

# -------------------- TOUCHSCREEN --------------------
touchscreen:
  - platform: gt911
    id: tft_touch
    display: tft_display

# -------------------- IMAGES --------------------
image:
  - file: mdi:home-assistant
    id: icon_home_assistant
    resize: 96x96
    type: rgb565
    transparency: alpha_channel

  - file: mdi:thermometer
    id: icon_temperature
    resize: 64x64
    type: rgb565
    transparency: alpha_channel

  - file: mdi:water-percent
    id: icon_humidity
    resize: 64x64
    type: rgb565
    transparency: alpha_channel

  - file: mdi:gauge
    id: icon_pressure
    resize: 64x64
    type: rgb565
    transparency: alpha_channel

  - file: mdi:battery-70
    id: icon_battery
    resize: 64x64
    type: rgb565
    transparency: alpha_channel

# -------------------- SENSORS (FROM HOME ASSISTANT) --------------------
sensor:
  # Temperature (from Home Assistant)
  - platform: homeassistant
    id: temperature
    unit_of_measurement: "°C"
    entity_id: sensor.outdoor_sensor_temperature
    on_value:
      - lvgl.label.update:
          id: temperature_value
          text:
            format: "%.0f"
            args: [ x ]
            if_nan: "??"

  # Humidity (from Home Assistant)
  - platform: homeassistant
    id: humidity
    unit_of_measurement: "%"
    entity_id: sensor.outdoor_sensor_humidity
    on_value:
      - lvgl.label.update:
          id: humidity_value
          text:
            format: "%.0f"
            args: [ x ]
            if_nan: "??"

  # Pressure (from Home Assistant)
  - platform: homeassistant
    id: presure
    unit_of_measurement: "mmHg"
    entity_id: sensor.outdoor_pressure_mmhg
    on_value:
      - lvgl.label.update:
          id: pressure_value
          text:
            format: "%.0f"
            args: [ x ]
            if_nan: "???"

  # Battery level (from Home Assistant)
  - platform: homeassistant
    id: battery
    entity_id: sensor.outdoor_sensor_battery
    unit_of_measurement: "%"
    on_value:
      # Update text like "83%"
      - lvgl.label.update:
          id: battery_value
          text:
            format: "%.0f%%"
            args: [ x ]
            if_nan: "??%"

      # Update progress bar (0–100)
      - lvgl.bar.update:
          id: battery_bar
          value: !lambda |-
            if (isnan(x)) {
              return 0;
            }
            float v = x;
            if (v < 0.0f) v = 0.0f;
            if (v > 100.0f) v = 100.0f;
            return (int) v;

  # Template sensor that exposes current backlight brightness in %
  - platform: template
    id: current_brightness_variable
    name: "Current Brightness"
    unit_of_measurement: "%"
    accuracy_decimals: 0
    state_class: "measurement"
    update_interval: 2s
    filters:
      - delta: 1.0   # Publish only if brightness changed by >= 1%
    lambda: |-
      // Light brightness is in range 0.0..1.0, convert to percentage
      return id(back_light).current_values.get_brightness() * 100.0f;
    on_value:
      # Keep brightness slider in sync with real backlight brightness (0..100)
      - lvgl.slider.update:
          id: brightness_slider
          value: !lambda 'return x;'
      # Keep percentage label in sync
      - lvgl.label.update:
          id: brightness_value_label
          text:
            format: "%.0f%%"
            args: [ x ]
            if_nan: "--%"

# -------------------- SCRIPTS (COLOR HANDLING) --------------------
script:
  # аauto return to home page after 30 seconds
  - id: settings_idle_timer
    mode: restart
    then:
      - delay: 30s
      - lvgl.page.show:
          id: main_page
          animation: MOVE_RIGHT
          time: 200ms

  # Apply current global text color (R/G/B) to all LVGL widgets
  - id: apply_text_color
    then:
      # Update labels (main page + settings page)
      - lvgl.label.update:
          id:
            # Main page labels
            - temperature_value
            - temperature_unit
            - humidity_value
            - humidity_unit
            - pressure_value
            - pressure_unit
            - battery_value
            # Settings page labels
            - brightness_label
            - brightness_value_label
            - color_label
            - color_r_value_label
            - color_g_value_label
            - color_b_value_label
          text_color: !lambda |-
            int r = id(text_color_r_glob);
            int g = id(text_color_g_glob);
            int b = id(text_color_b_glob);

            if (r < 0) r = 0; if (r > 255) r = 255;
            if (g < 0) g = 0; if (g > 255) g = 255;
            if (b < 0) b = 0; if (b > 255) b = 255;

            uint32_t rgb = ((uint32_t)r << 16) | ((uint32_t)g << 8) | (uint32_t)b;
            return lv_color_hex(rgb);

      # Update battery bar frame and indicator
      - lvgl.bar.update:
          id: battery_bar
          border_color: !lambda |-
            int r = id(text_color_r_glob);
            int g = id(text_color_g_glob);
            int b = id(text_color_b_glob);
            if (r < 0) r = 0; if (r > 255) r = 255;
            if (g < 0) g = 0; if (g > 255) g = 255;
            if (b < 0) b = 0; if (b > 255) b = 255;
            uint32_t rgb = ((uint32_t)r << 16) | ((uint32_t)g << 8) | (uint32_t)b;
            return lv_color_hex(rgb);
          indicator:
            bg_color: !lambda |-
              int r = id(text_color_r_glob);
              int g = id(text_color_g_glob);
              int b = id(text_color_b_glob);
              if (r < 0) r = 0; if (r > 255) r = 255;
              if (g < 0) g = 0; if (g > 255) g = 255;
              if (b < 0) b = 0; if (b > 255) b = 255;
              uint32_t rgb = ((uint32_t)r << 16) | ((uint32_t)g << 8) | (uint32_t)b;
              return lv_color_hex(rgb);

      # Update brightness slider visuals (indicator + knob)
      - lvgl.slider.update:
          id: brightness_slider
          indicator:
            bg_color: !lambda |-
              int r = id(text_color_r_glob);
              int g = id(text_color_g_glob);
              int b = id(text_color_b_glob);
              if (r < 0) r = 0; if (r > 255) r = 255;
              if (g < 0) g = 0; if (g > 255) g = 255;
              if (b < 0) b = 0; if (b > 255) b = 255;
              uint32_t rgb = ((uint32_t)r << 16) | ((uint32_t)g << 8) | (uint32_t)b;
              return lv_color_hex(rgb);
          knob:
            bg_color: !lambda |-
              int r = id(text_color_r_glob);
              int g = id(text_color_g_glob);
              int b = id(text_color_b_glob);
              if (r < 0) r = 0; if (r > 255) r = 255;
              if (g < 0) g = 0; if (g > 255) g = 255;
              if (b < 0) b = 0; if (b > 255) b = 255;
              uint32_t rgb = ((uint32_t)r << 16) | ((uint32_t)g << 8) | (uint32_t)b;
              return lv_color_hex(rgb);

  # Update color sliders, numeric labels and preview from globals
  - id: update_color_ui
    then:
      # Update sliders (0..255)
      - lvgl.slider.update:
          id: color_r_slider
          value: !lambda 'return id(text_color_r_glob);'
      - lvgl.slider.update:
          id: color_g_slider
          value: !lambda 'return id(text_color_g_glob);'
      - lvgl.slider.update:
          id: color_b_slider
          value: !lambda 'return id(text_color_b_glob);'

      # Update numeric labels
      - lvgl.label.update:
          id: color_r_value_label
          text: !lambda |-
            char buf[4];
            sprintf(buf, "%d", id(text_color_r_glob));
            return std::string(buf);
      - lvgl.label.update:
          id: color_g_value_label
          text: !lambda |-
            char buf[4];
            sprintf(buf, id(text_color_g_glob) < 100 ? "%d" : "%d", id(text_color_g_glob));
            return std::string(buf);
      - lvgl.label.update:
          id: color_b_value_label
          text: !lambda |-
            char buf[4];
            sprintf(buf, "%d", id(text_color_b_glob));
            return std::string(buf);

      - lvgl.label.update:
          id: color_hex_label
          text: !lambda |-
            int r = id(text_color_r_glob);
            int g = id(text_color_g_glob);
            int b = id(text_color_b_glob);
            if (r < 0) r = 0; if (r > 255) r = 255;
            if (g < 0) g = 0; if (g > 255) g = 255;
            if (b < 0) b = 0; if (b > 255) b = 255;
            char buf[10];
            sprintf(buf, "#%02X%02X%02X", r, g, b);
            return std::string(buf);

      # Update color preview rectangle
      - lvgl.obj.update:
          id: color_preview
          bg_color: !lambda |-
            int r = id(text_color_r_glob);
            int g = id(text_color_g_glob);
            int b = id(text_color_b_glob);
            if (r < 0) r = 0; if (r > 255) r = 255;
            if (g < 0) g = 0; if (g > 255) g = 255;
            if (b < 0) b = 0; if (b > 255) b = 255;
            uint32_t rgb = ((uint32_t)r << 16) | ((uint32_t)g << 8) | (uint32_t)b;
            return lv_color_hex(rgb);

# -------------------- LVGL CONFIGURATION --------------------
lvgl:
  log_level: INFO
  buffer_size: 25%
  disp_bg_color: 0x000000
  default_font: montserrat_27

  displays:
    - tft_display

  touchscreens:
    - touchscreen_id: tft_touch

  # Коли LVGL повністю ініціалізований – застосовуємо збережений колір
  on_ready:
    then:
      - script.execute: apply_text_color
      - script.execute: update_color_ui

  pages:
    # ================= MAIN PAGE (DEFAULT) =================
    - id: main_page
      bg_color: 0x000000

      widgets:
        # ---------- TEMPERATURE (centered group) ----------
        - obj:
            id: temperature_group
            align: TOP_MID      # Center horizontally on screen
            y: 0                # Vertical offset from top
            width: SIZE_CONTENT
            height: SIZE_CONTENT
            bg_color: 0x000000
            border_color: 0x000000
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: CENTER
              flex_align_cross: CENTER
              pad_column: 10    # Horizontal gap between children
            widgets:
              - image:
                  id: temperature_icon_widget
                  src: icon_temperature
                  image_recolor: 0xFFFFFF
                  image_recolor_opa: COVER

              - label:
                  id: temperature_value
                  text: "??"
                  text_font: montserrat_120
                  text_color: 0xFFFFFF

              - label:
                  id: temperature_unit
                  text: "°C"
                  text_font: montserrat_96
                  text_color: 0xFFFFFF

        # ---------- HUMIDITY (centered group) ----------
        - obj:
            id: humidity_group
            align: TOP_MID      # Center horizontally on screen
            y: 150              # Vertical offset from top
            width: SIZE_CONTENT
            height: SIZE_CONTENT
            bg_color: 0x000000
            border_color: 0x000000
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: CENTER
              flex_align_cross: CENTER
              pad_column: 10    # Horizontal gap between children
            widgets:
              - image:
                  id: humidity_icon_widget
                  src: icon_humidity
                  image_recolor: 0xFFFFFF
                  image_recolor_opa: COVER

              - label:
                  id: humidity_value
                  text: "??"
                  text_font: montserrat_120
                  text_color: 0xFFFFFF

              - label:
                  id: humidity_unit
                  text: "%"
                  text_font: montserrat_96
                  text_color: 0xFFFFFF

        # ---------- PRESSURE ----------
        - obj:
            id: pressure_group
            align: TOP_LEFT     # Place near bottom-left
            y: 320              # Vertical offset from top
            width: SIZE_CONTENT
            height: SIZE_CONTENT
            bg_color: 0x000000
            border_color: 0x000000
            widgets:
              - image:
                  id: pressure_icon_widget
                  src: icon_pressure
                  y: -10
                  image_recolor: 0xFFFFFF
                  image_recolor_opa: COVER

              - label:
                  id: pressure_value
                  text: "???"
                  align_to:
                    id: pressure_unit
                    align: BOTTOM_MID
                    x: 0
                    y: -30
                  text_font: montserrat_45
                  text_color: 0xFFFFFF

              - label:
                  id: pressure_unit
                  text: "mmHg"
                  x: 70
                  y: 30
                  text_font: montserrat_27
                  text_color: 0xFFFFFF

        # ---------- BATTERY ----------
        - obj:
            id: battery_group
            align: TOP_RIGHT    # Place near bottom-right
            y: 320              # Vertical offset from top
            width: SIZE_CONTENT
            height: SIZE_CONTENT
            bg_color: 0x000000
            border_color: 0x000000
            widgets:
              - image:
                  id: battery_icon_widget
                  src: icon_battery
                  y: -10
                  image_recolor: 0xFFFFFF
                  image_recolor_opa: COVER

              - label:
                  id: battery_value
                  text: "??%"
                  align_to:
                    id: battery_bar
                    align: BOTTOM_MID
                    x: 0
                    y: -26
                  text_font: montserrat_45
                  text_color: 0xFFFFFF

              - bar:
                  id: battery_bar
                  x: 70
                  y: 40
                  width: 100
                  height: 20
                  min_value: 0
                  max_value: 100
                  # Frame around the whole bar
                  bg_color: 0x000000        # Background inside the frame
                  bg_opa: 0%                # Make background transparent if you want only the frame
                  border_color: 0xFFFFFF    # Frame color
                  border_width: 2           # Frame thickness
                  radius: 0                 # Square corners
                  indicator:
                    bg_color: 0xFFFFFF
                    bg_opa: 100%
                    radius: 0              # Keep same shape as outer frame
                    border_width: 0        # No border on indicator

        # ---------- HOME ASSISTANT ICON (switch to settings) ----------
        - image:
            id: ha_icon_widget
            src: icon_home_assistant
            align: BOTTOM_MID
            y: -20
            image_recolor: 0xFFFFFF
            image_recolor_opa: COVER
            on_click:
              then:
                - script.execute: settings_idle_timer      # start/reset timer
                - lvgl.page.show:
                    id: settings_page
                    animation: MOVE_LEFT
                    time: 200ms

    # ================= SETTINGS PAGE =================
    - id: settings_page
      bg_color: 0x000000

      widgets:
        # ---------- BRIGHTNESS GROUP ----------
        - obj:
            id: brightness_group
            align: TOP_MID
            y: 0
            width: 440
            height: SIZE_CONTENT
            bg_color: 0x000000
            border_color: 0x000000
            layout:
              type: FLEX
              flex_flow: COLUMN
              flex_align_main: CENTER
              flex_align_cross: STRETCH
              pad_row: 8
            widgets:
              # Header: "Brightness  100%" – text and percent on one line
              - obj:
                  id: brightness_header
                  width: 400
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  bg_color: 0x000000
                  border_color: 0x000000
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_column: 10      # Space between "Brightness" and "100%"
                  widgets:
                    - label:
                        id: brightness_label
                        text: "Brightness"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF
                    - label:
                        id: brightness_value_label
                        text: "100%"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

              # Slider controlling backlight brightness directly
              - slider:
                  id: brightness_slider
                  width: 400
                  height: 20
                  min_value: 5        # Avoid too low brightness
                  max_value: 100
                  value: 100
                  bg_color: 0x404040
                  border_width: 0     # No frame around slider
                  radius: 4
                  indicator:
                    bg_color: 0xFFFFFF
                  knob:
                    bg_color: 0xFFFFFF
                  on_change:
                    then:
                      - script.execute: settings_idle_timer   
                      # Apply brightness immediately to backlight
                      - lambda: |-
                          // x is in range [5 .. 100]
                          float v = x / 100.0f;
                          if (v < 0.02f) {
                            v = 0.02f;  // Avoid fully turning off backlight
                          }
                          auto call = id(back_light).turn_on();
                          call.set_brightness(v);
                          call.perform();
                      # Update percentage label
                      - lvgl.label.update:
                          id: brightness_value_label
                          text:
                            format: "%.0f%%"
                            args: [ x ]
                            if_nan: "??%"

        # ---------- COLOR GROUP (R/G/B sliders + preview) ----------
        - obj:
            id: color_group
            align: TOP_MID
            y: 110
            width: 480
            height: SIZE_CONTENT
            bg_color: 0x000000
            border_color: 0x000000
            layout:
              type: FLEX
              flex_flow: COLUMN
              flex_align_main: CENTER
              flex_align_cross: STRETCH
              pad_row: 2
            widgets:
              # Header + preview
              - obj:
                  id: color_header
                  width: 440
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  bg_color: 0x000000
                  border_color: 0x000000
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                    flex_align_cross: CENTER
                    pad_column: 20
                  widgets:
                    - label:
                        id: color_label
                        text: "Text color:"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

                    # New label with HEX value between text and preview
                    - label:
                        id: color_hex_label
                        text: "#FFFFFF"        # initial value, will be updated from script
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

                    - obj:
                        id: color_preview
                        width: 60
                        height: 30
                        bg_color: 0xFFFFFF
                        border_color: 0xFFFFFF
                        border_width: 2
                        radius: 4

              # R
              - obj:
                  id: color_r_group
                  width: 440
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  bg_color: 0x000000
                  border_color: 0x000000
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_column: 20
                  widgets:
                    - label:
                        id: color_r_label
                        text: "R"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

                    - slider:
                        id: color_r_slider
                        width: 280
                        height: 18
                        min_value: 0
                        max_value: 255
                        value: 255
                        bg_color: 0x404040
                        radius: 4
                        indicator:
                          bg_color: 0xFF0000
                        knob:
                          bg_color: 0xFF0000
                        on_change:
                          then:
                            - script.execute: settings_idle_timer   
                            - lambda: |-
                                // Update global R channel
                                id(text_color_r_glob) = (int) x;
                            - script.execute: apply_text_color
                            - script.execute: update_color_ui
                            - text.set:
                                id: text_color_hex
                                value: !lambda |-
                                  int r = id(text_color_r_glob);
                                  int g = id(text_color_g_glob);
                                  int b = id(text_color_b_glob);
                                  if (r < 0) r = 0; if (r > 255) r = 255;
                                  if (g < 0) g = 0; if (g > 255) g = 255;
                                  if (b < 0) b = 0; if (b > 255) b = 255;
                                  char buf[8];
                                  sprintf(buf, "%02X%02X%02X", r, g, b);
                                  return std::string(buf);

                    - label:
                        id: color_r_value_label
                        text: "255"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

              # G
              - obj:
                  id: color_g_group
                  width: 440
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  bg_color: 0x000000
                  border_color: 0x000000
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_column: 20
                  widgets:
                    - label:
                        id: color_g_label
                        text: "G"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

                    - slider:
                        id: color_g_slider
                        width: 280
                        height: 18
                        min_value: 0
                        max_value: 255
                        value: 255
                        bg_color: 0x404040
                        radius: 4
                        indicator:
                          bg_color: 0x00FF00
                        knob:
                          bg_color: 0x00FF00
                        on_change:
                          then:
                            - script.execute: settings_idle_timer   
                            - lambda: |-
                                // Update global G channel
                                id(text_color_g_glob) = (int) x;
                            - script.execute: apply_text_color
                            - script.execute: update_color_ui
                            - text.set:
                                id: text_color_hex
                                value: !lambda |-
                                  int r = id(text_color_r_glob);
                                  int g = id(text_color_g_glob);
                                  int b = id(text_color_b_glob);
                                  if (r < 0) r = 0; if (r > 255) r = 255;
                                  if (g < 0) g = 0; if (g > 255) g = 255;
                                  if (b < 0) b = 0; if (b > 255) b = 255;
                                  char buf[8];
                                  sprintf(buf, "%02X%02X%02X", r, g, b);
                                  return std::string(buf);

                    - label:
                        id: color_g_value_label
                        text: "255"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

              # B
              - obj:
                  id: color_b_group
                  width: 440
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  bg_color: 0x000000
                  border_color: 0x000000
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_column: 20
                  widgets:
                    - label:
                        id: color_b_label
                        text: "B"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

                    - slider:
                        id: color_b_slider
                        width: 280
                        height: 18
                        min_value: 0
                        max_value: 255
                        value: 255
                        bg_color: 0x404040
                        radius: 4
                        indicator:
                          bg_color: 0x0000FF
                        knob:
                          bg_color: 0x0000FF
                        on_change:
                          then:
                            - script.execute: settings_idle_timer   
                            - lambda: |-
                                // Update global B channel
                                id(text_color_b_glob) = (int) x;
                            - script.execute: apply_text_color
                            - script.execute: update_color_ui
                            - text.set:
                                id: text_color_hex
                                value: !lambda |-
                                  int r = id(text_color_r_glob);
                                  int g = id(text_color_g_glob);
                                  int b = id(text_color_b_glob);
                                  if (r < 0) r = 0; if (r > 255) r = 255;
                                  if (g < 0) g = 0; if (g > 255) g = 255;
                                  if (b < 0) b = 0; if (b > 255) b = 255;
                                  char buf[8];
                                  sprintf(buf, "%02X%02X%02X", r, g, b);
                                  return std::string(buf);

                    - label:
                        id: color_b_value_label
                        text: "255"
                        text_font: montserrat_27
                        text_color: 0xFFFFFF

        # ---------- HOME ASSISTANT ICON (switch back to main page) ----------
        - image:
            id: ha_icon_widget_settings
            src: icon_home_assistant
            align: BOTTOM_MID
            y: -20
            image_recolor: 0xFFFFFF
            image_recolor_opa: COVER
            on_click:
              then:
                - script.stop: settings_idle_timer         # stop timer
                - lvgl.page.show:
                    id: main_page
                    animation: MOVE_RIGHT
                    time: 200ms
